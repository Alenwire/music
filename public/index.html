<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>æˆ‘çš„éŸ³ä¹æ’­æ”¾å™¨</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f7f7f7;
        }
        input {
            width: 300px;
            padding: 8px;
        }
        button {
            padding: 8px 16px;
            margin-left: 10px;
        }
        li {
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            background: #fff;
            border-radius: 4px;
            list-style: none;
        }
        li:hover {
            background: #e3e3e3;
        }
        .active {
            font-weight: bold;
            color: #d9534f;
            background: #ffecec !important;
        }
    </style>
</head>
<body>

<h2>éŸ³ä¹æ’­æ”¾å™¨ ğŸ¶</h2>

<input id="url" placeholder="è¾“å…¥ Bç«™é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.bilibili.com/video/xxx">
<button onclick="addMusic()">æ·»åŠ </button>

<h3>æ’­æ”¾åˆ—è¡¨</h3>

<button id="modeBtn" onclick="switchMode()">ğŸ”‚ åˆ—è¡¨å¾ªç¯</button>

<ul id="playlist"></ul>

<audio id="player" controls style="width: 100%; margin-top: 20px;"></audio>


<!-- ============================  
        æ’­æ”¾å™¨æ ¸å¿ƒé€»è¾‘  
     ============================ -->
<script>
// æ’­æ”¾åˆ—è¡¨
let playlist = JSON.parse(localStorage.getItem("playlist") || "[]");
// æ’­æ”¾æ¨¡å¼ï¼šlist=åˆ—è¡¨å¾ªç¯ / single=å•æ›² / order=é¡ºåº
let mode = localStorage.getItem("mode") || "list";
// å½“å‰æ’­æ”¾ç¼–å·
let current = parseInt(localStorage.getItem("current") || "-1");

const playlistEl = document.getElementById("playlist");
const player = document.getElementById("player");

// åˆå§‹åŒ–
renderPlaylist();
updateModeButton();

// å¦‚æœä¹‹å‰æœ‰æ’­æ”¾ï¼Œåˆ™æ¢å¤
if (current >= 0 && playlist[current]) {
    player.src = "/proxy?url=" + encodeURIComponent(playlist[current].audio);
}

// æ·»åŠ éŸ³ä¹
async function addMusic() {
    const url = document.getElementById("url").value.trim();
    if (!url) return alert("è¯·è¾“å…¥é“¾æ¥");

    const res = await fetch(`/api/audio?url=${encodeURIComponent(url)}`);
    const data = await res.json();

    if (!data.success) return alert("è§£æå¤±è´¥");

    playlist.push({ title: data.title, audio: data.audio });
    localStorage.setItem("playlist", JSON.stringify(playlist));

    renderPlaylist();
    document.getElementById("url").value = "";
}

// æ›´æ–°æ’­æ”¾æ¨¡å¼æŒ‰é’®
function updateModeButton() {
    const btn = document.getElementById("modeBtn");
    if (mode === "single") btn.innerText = "ğŸ” å•æ›²å¾ªç¯";
    else if (mode === "list") btn.innerText = "ğŸ”‚ åˆ—è¡¨å¾ªç¯";
    else btn.innerText = "â¡ é¡ºåºæ’­æ”¾";
}

// åˆ‡æ¢æ¨¡å¼
function switchMode() {
    if (mode === "list") mode = "single";
    else if (mode === "single") mode = "order";
    else mode = "list";

    localStorage.setItem("mode", mode);
    updateModeButton();
}

// æ’­æ”¾æŒ‡å®š index
function playIndex(i) {
    current = i;
    localStorage.setItem("current", current);

    player.src = "/proxy?url=" + encodeURIComponent(playlist[i].audio);
    player.play();

    renderPlaylist();
}

// æ¸²æŸ“åˆ—è¡¨
function renderPlaylist() {
    playlistEl.innerHTML = "";

    playlist.forEach((item, i) => {
        const li = document.createElement("li");
        li.innerText = item.title;

        // å½“å‰æ’­æ”¾é«˜äº®
        if (i === current) li.classList.add("active");

        li.onclick = () => playIndex(i);
        playlistEl.appendChild(li);
    });
}

// è‡ªåŠ¨ä¸‹ä¸€æ›²
player.addEventListener("ended", () => {
    if (mode === "single") {
        player.play();
        return;
    }

    if (mode === "list") {
        current = (current + 1) % playlist.length;
    } else if (mode === "order") {
        current++;
        if (current >= playlist.length) return; // ç›´æ¥åœæ­¢
    }

    localStorage.setItem("current", current);
    playIndex(current);
});
</script>

</body>
</html>
